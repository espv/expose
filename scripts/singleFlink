#!/bin/bash
EXPOSE_PATH=$(realpath "$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )/..")
number_threads=$1
client_ip=$(hostname -I | cut -d' ' -f1)
client_port=$2
coordinator_ip=$3
coordinator_port=$4
node_id=$5
trace_path=$6/node-$node_id
unused_cpu_core=$7

mkdir -p $trace_path
classpath=$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-experiments/target/flink-experiments-1.9-SNAPSHOT-jar-with-dependencies.jar:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-streaming-java/target/classes:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-core/target/classes:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-annotations/target/classes:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-metrics/flink-metrics-core/target/classes:~/.m2/repository/org/apache/flink/flink-shaded-asm-6/6.2.1-7.0/flink-shaded-asm-6-6.2.1-7.0.jar:~/.m2/repository/com/esotericsoftware/kryo/kryo/2.24.0/kryo-2.24.0.jar:~/.m2/repository/com/esotericsoftware/minlog/minlog/1.2/minlog-1.2.jar:~/.m2/repository/commons-collections/commons-collections/3.2.2/commons-collections-3.2.2.jar:~/.m2/repository/org/apache/commons/commons-compress/1.18/commons-compress-1.18.jar:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-runtime/target/classes:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-queryable-state/flink-queryable-state-client-java/target/classes:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-filesystems/flink-hadoop-fs/target/classes:~/.m2/repository/commons-io/commons-io/2.4/commons-io-2.4.jar:~/.m2/repository/org/apache/flink/flink-shaded-netty/4.1.32.Final-7.0/flink-shaded-netty-4.1.32.Final-7.0.jar:~/.m2/repository/commons-cli/commons-cli/1.3.1/commons-cli-1.3.1.jar:~/.m2/repository/org/javassist/javassist/3.19.0-GA/javassist-3.19.0-GA.jar:~/.m2/repository/com/typesafe/akka/akka-actor_2.11/2.5.21/akka-actor_2.11-2.5.21.jar:~/.m2/repository/com/typesafe/config/1.3.0/config-1.3.0.jar:~/.m2/repository/org/scala-lang/modules/scala-java8-compat_2.11/0.7.0/scala-java8-compat_2.11-0.7.0.jar:~/.m2/repository/com/typesafe/akka/akka-remote_2.11/2.5.21/akka-remote_2.11-2.5.21.jar:~/.m2/repository/com/typesafe/akka/akka-stream_2.11/2.5.21/akka-stream_2.11-2.5.21.jar:~/.m2/repository/org/reactivestreams/reactive-streams/1.0.2/reactive-streams-1.0.2.jar:~/.m2/repository/com/typesafe/ssl-config-core_2.11/0.3.7/ssl-config-core_2.11-0.3.7.jar:~/.m2/repository/com/typesafe/akka/akka-protobuf_2.11/2.5.21/akka-protobuf_2.11-2.5.21.jar:~/.m2/repository/com/typesafe/akka/akka-slf4j_2.11/2.5.21/akka-slf4j_2.11-2.5.21.jar:~/.m2/repository/org/clapper/grizzled-slf4j_2.11/1.3.2/grizzled-slf4j_2.11-1.3.2.jar:~/.m2/repository/com/github/scopt/scopt_2.11/3.5.0/scopt_2.11-3.5.0.jar:~/.m2/repository/org/xerial/snappy/snappy-java/1.1.4/snappy-java-1.1.4.jar:~/.m2/repository/com/twitter/chill_2.11/0.7.6/chill_2.11-0.7.6.jar:~/.m2/repository/com/twitter/chill-java/0.7.6/chill-java-0.7.6.jar:~/.m2/repository/org/apache/zookeeper/zookeeper/3.4.10/zookeeper-3.4.10.jar:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-shaded-curator/target/classes:~/.m2/repository/org/apache/curator/curator-recipes/2.12.0/curator-recipes-2.12.0.jar:~/.m2/repository/org/apache/curator/curator-framework/2.12.0/curator-framework-2.12.0.jar:~/.m2/repository/org/apache/curator/curator-client/2.12.0/curator-client-2.12.0.jar:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-clients/target/classes:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-optimizer/target/classes:~/.m2/repository/org/apache/flink/flink-shaded-guava/18.0-7.0/flink-shaded-guava-18.0-7.0.jar:~/.m2/repository/org/apache/commons/commons-math3/3.5/commons-math3-3.5.jar:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-streaming-scala/target/classes:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-scala/target/classes:~/.m2/repository/org/scala-lang/scala-reflect/2.11.12/scala-reflect-2.11.12.jar:~/.m2/repository/org/scala-lang/scala-library/2.11.12/scala-library-2.11.12.jar:~/.m2/repository/org/scala-lang/scala-compiler/2.11.12/scala-compiler-2.11.12.jar:~/.m2/repository/org/scala-lang/modules/scala-xml_2.11/1.0.5/scala-xml_2.11-1.0.5.jar:~/.m2/repository/org/scala-lang/modules/scala-parser-combinators_2.11/1.1.1/scala-parser-combinators_2.11-1.1.1.jar:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-connectors/flink-connector-twitter/target/classes:~/.m2/repository/com/twitter/hbc-core/2.2.0/hbc-core-2.2.0.jar:~/.m2/repository/org/apache/httpcomponents/httpclient/4.5.3/httpclient-4.5.3.jar:~/.m2/repository/org/apache/httpcomponents/httpcore/4.4.6/httpcore-4.4.6.jar:~/.m2/repository/commons-logging/commons-logging/1.1.3/commons-logging-1.1.3.jar:~/.m2/repository/com/twitter/joauth/6.0.2/joauth-6.0.2.jar:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-connectors/flink-connector-kafka-0.10/target/classes:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-connectors/flink-connector-kafka-0.9/target/classes:~/.m2/repository/org/apache/kafka/kafka-clients/0.10.2.1/kafka-clients-0.10.2.1.jar:~/.m2/repository/net/jpountz/lz4/lz4/1.3.0/lz4-1.3.0.jar:~/.m2/repository/org/apache/flink/flink-shaded-jackson/2.10.1-9.0/flink-shaded-jackson-2.10.1-9.0.jar:~/.m2/repository/org/apache/bahir/flink-connector-netty_2.11/1.1-SNAPSHOT/flink-connector-netty_2.11-1.1-20190927.160545-2.jar:~/.m2/repository/io/netty/netty-all/4.1.5.Final/netty-all-4.1.5.Final.jar:~/.m2/repository/org/apache/commons/commons-lang3/3.3.2/commons-lang3-3.3.2.jar:~/.m2/repository/org/apache/bahir/flink-connector-activemq_2.11/1.1-SNAPSHOT/flink-connector-activemq_2.11-1.1-20190927.160244-2.jar:~/.m2/repository/org/apache/activemq/activemq-client/5.14.0/activemq-client-5.14.0.jar:~/.m2/repository/org/apache/geronimo/specs/geronimo-jms_1.1_spec/1.1.1/geronimo-jms_1.1_spec-1.1.1.jar:~/.m2/repository/org/fusesource/hawtbuf/hawtbuf/1.11/hawtbuf-1.11.jar:~/.m2/repository/org/apache/geronimo/specs/geronimo-j2ee-management_1.1_spec/1.0.1/geronimo-j2ee-management_1.1_spec-1.0.1.jar:~/.m2/repository/io/netty/netty/3.10.6.Final/netty-3.10.6.Final.jar:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-state-backends/flink-statebackend-rocksdb/target/classes:~/.m2/repository/com/data-artisans/frocksdbjni/5.17.2-artisans-1.0/frocksdbjni-5.17.2-artisans-1.0.jar:~/.m2/repository/com/googlecode/json-simple/json-simple/1.1.1/json-simple-1.1.1.jar:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-table/flink-table-api-java-bridge/target/classes:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-table/flink-table-api-java/target/classes:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-java/target/classes:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-table/flink-table-planner/target/classes:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-table/flink-table-common/target/classes:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-table/flink-table-api-scala-bridge/target/classes:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-table/flink-sql-parser/target/classes:~/.m2/repository/org/codehaus/janino/janino/3.0.9/janino-3.0.9.jar:~/.m2/repository/org/codehaus/janino/commons-compiler/3.0.9/commons-compiler-3.0.9.jar:~/.m2/repository/org/apache/calcite/calcite-core/1.20.0/calcite-core-1.20.0.jar:~/.m2/repository/commons-codec/commons-codec/1.10/commons-codec-1.10.jar:~/.m2/repository/org/apache/calcite/avatica/avatica-core/1.15.0/avatica-core-1.15.0.jar:~/.m2/repository/org/apache/calcite/calcite-linq4j/1.20.0/calcite-linq4j-1.20.0.jar:~/.m2/repository/com/fasterxml/jackson/core/jackson-core/2.9.8/jackson-core-2.9.8.jar:~/.m2/repository/com/fasterxml/jackson/core/jackson-annotations/2.9.8/jackson-annotations-2.9.8.jar:~/.m2/repository/com/fasterxml/jackson/core/jackson-databind/2.9.8/jackson-databind-2.9.8.jar:~/.m2/repository/com/jayway/jsonpath/json-path/2.4.0/json-path-2.4.0.jar:~/.m2/repository/joda-time/joda-time/2.5/joda-time-2.5.jar:~/.m2/repository/com/google/guava/guava/23.0/guava-23.0.jar:~/.m2/repository/com/google/errorprone/error_prone_annotations/2.0.18/error_prone_annotations-2.0.18.jar:~/.m2/repository/com/google/j2objc/j2objc-annotations/1.1/j2objc-annotations-1.1.jar:~/.m2/repository/org/codehaus/mojo/animal-sniffer-annotations/1.14/animal-sniffer-annotations-1.14.jar:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-libraries/flink-cep/target/classes:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-table/flink-table-planner-blink/target/classes:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-table/flink-table-api-scala/target/classes:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/flink-table/flink-table-runtime-blink/target/classes:~/.m2/repository/org/lz4/lz4-java/1.5.0/lz4-java-1.5.0.jar:~/.m2/repository/org/yaml/snakeyaml/1.24/snakeyaml-1.24.jar:~/.m2/repository/no/uio/ifi/experimentframework/1.0/experimentframework-1.0.jar:~/.m2/repository/org/apache/commons/commons-text/1.8/commons-text-1.8.jar:~/.m2/repository/org/apache/flink/flink-connector-kafka_2.11/1.9.0/flink-connector-kafka_2.11-1.9.0.jar:~/.m2/repository/org/apache/flink/flink-connector-kafka-base_2.11/1.9.0/flink-connector-kafka-base_2.11-1.9.0.jar:$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper/tools/force-shading/target/classes:~/.m2/repository/org/slf4j/slf4j-api/1.7.15/slf4j-api-1.7.15.jar:~/.m2/repository/com/google/code/findbugs/jsr305/1.3.9/jsr305-1.3.9.jar:~/.m2/repository/org/objenesis/objenesis/2.1/objenesis-2.1.jar
FLINK_PATH=$EXPOSE_PATH/SPEs-plus-wrappers/flink-plus-wrapper
FLINK_BINARIES=$FLINK_PATH/flink-1.9.1
KAFKA_PATH=$FLINK_PATH/kafka
KAFKA_PATH=$KAFKA_PATH $EXPOSE_PATH/scripts/start-zookeeper
KAFKA_PATH=$KAFKA_PATH $EXPOSE_PATH/scripts/start-kafka

if [[ -z $unused_cpu_core ]]
then
	FLINK_BINARIES=$FLINK_BINARIES EXPOSE_PATH=$EXPOSE_PATH java -Xms2g -Dakka.client.timeout:600s -Dakka.ask.timeout:600s -classpath $classpath org.apache.flink.experiments.FlinkExperimentFramework --client-ip $client_ip --client-port 9092 --coordinator-ip $coordinator_ip --coordinator-port $coordinator_port --node-id $node_id --trace-output-folder $trace_path
else
	FLINK_BINARIES=$FLINK_BINARIES EXPOSE_PATH=$EXPOSE_PATH taskset -c $unused_cpu_core java -Xms2g -Dthread.pool.size=$number_threads -XX:ActiveProcessorCount=$number_threads -Dakka.client.timeout:600s -Dakka.ask.timeout:600s -classpath $classpath org.apache.flink.experiments.FlinkExperimentFramework --client-ip $client_ip --client-port 9092 --coordinator-ip $coordinator_ip --coordinator-port $coordinator_port --node-id $node_id --trace-output-folder $trace_path
fi
